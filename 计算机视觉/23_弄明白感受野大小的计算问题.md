## 感受野Receptive field (RF)的概念

卷及神经网络中每一层输出的特征图(feature map)中的每一个像素映射到原始输入图像的区域大小。

## 卷积输入输出的大小关系
根据感受野的概念，大家可以体会到感受野的计算应该与卷积的计算是相反的过程，所以先回顾下卷积输入输出的大小关系公式：（以高度为例）
$$
Height_{out} = (Height_{in} - F+2*P)/S + 1
$$
其中`F`为滤波器的边长，`P`为padding的大小，`S`为步长。

## padding的计算方法

以下都是根据式1计算得出，只是padding的值不同

**padding=same**时

根据式（1）反推即可
$$
P = \frac{(H_O-1)S+F-H_I}{2}
$$
当步长为1时，也可以直接根据卷积核大小F求得
$$
P=(F-1)//2
$$
输出特征图大小
$$
H_O=H_I
$$
**padding=valid时**

不需要计算padding，只需要记住他的输出特征图大小的计算方法（其实就是padding=0时的公式1）
$$
H_O=(H_I-F)//S+1
$$
**padding=full时**

padding就是$F-1$，根据式1可以得出，特征图输出大小
$$
H_O=(H_I-F+2(F-1))//S+1=(H_I+F-2)//S+1
$$


## 感受野的计算

上面说了感受野的计算是与卷积计算相反的过程，**卷积是从低层慢慢一层层卷积到高层的**，所以感受野的计算采用的是`Top-Down`方式，即**从最高层向低层迭代计算**。具体步骤为：
 1. 设要计算感受野的这层为第N层

 2. 第`N`层到第`N-1`层的感受野就是对第`N-1`层进行卷积时使用的滤波器大小，这里我们设为$RF_{N-1}$。

 3. 接着计算第`N`层到第`N-2`层的感受野大小，公式是：
 $$
 RF_{N-2} = (RF_{N-1} -1)*stride + kernel\_size
 $$
 **（需要注意的是这里的`stride`和`kernel_size`是第`N-2`层的）**
 
 4. 一直迭代第３步直至输入层，即可算出第N层在输入层的感受野

这里大家注意下第３步中的公式，体会下是不是刚好与上面卷积输入输出的关系刚好反过来，$RF_{N-2}$对应$Height_{in}$，$RF_{N-1}$对应$Height_{out}$。

唯一的区别是不需要管padding，这也说明了感受野其实是包括padding在内的，所以你会发现算出来的感受野大小可能会比原始图像的大小还要大。

如上一段所说，**其实这样的计算方法是有一点问题的，没有考虑padding和pooling部分，要做修改。但这种方法还是可以应对面试时候的感受野计算问题的**，若是研究过程中要计算非常准确的感受野大小的话，还是得再深入研究下，大家可以看看下面的两个参考资料。

### 感受野计算例子

![在这里插入图片描述](https://img-blog.csdnimg.cn/20191010102440809.png)

从最后一层的池化层开始计算感受野：
$$
\begin{aligned}
pool3：&RF=2（最后一层池化层输出特征图的感受野大小等于卷积核的大小）\\
conv4：&RF=(2-1)*1+3=4。\\
conv3：&RF=(4-1)*1+3=6。\\
pool2：&RF=(6-1)*2+2=12。\\
conv2：&RF=(12-1)*1+3=14。\\
pool1：&RF=(14-1)*2+2=28。\\
conv1：&RF=(28-1)*1+3=30。\\
\end{aligned}
$$
因此，pool3输出的特征图在输入图片上的感受野为30*30。

**要从最后一层向前计算感受野，而不是从前往后计算感受野。**

## 参考资料
[如何计算感受野(Receptive Field)——原理](https://zhuanlan.zhihu.com/p/31004121)
[Calculate Receptive Field for VGG16](http://zike.io/posts/calculate-receptive-field-for-vgg-16/)